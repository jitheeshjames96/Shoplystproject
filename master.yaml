AWSTemplateFormatVersion: '2010-09-09'
Description: Master CloudFormation template to deploy web application infrastructure using nested stacks

Parameters:
  VpcTemplateUrl:
    Type: String
    Description: S3 URL for vpc.yaml
  SecurityTemplateUrl:
    Type: String
    Description: S3 URL for security.yaml
  ComputeTemplateUrl:
    Type: String
    Description: S3 URL for compute.yaml
  RdsTemplateUrl:
    Type: String
    Description: S3 URL for rds.yaml
  BootstrapTemplateUrl:
    Type: String
    Description: S3 URL for bootstrap.yaml
  VpcCIDR:
    Type: String
  PublicSubnet1CIDR:
    Type: String
  PublicSubnet2CIDR:
    Type: String
  PrivateSubnet1CIDR:
    Type: String
  PrivateSubnet2CIDR:
    Type: String
  DBUsername:
    Type: String
  DBPassword:
    Type: String
  KeyName:
    Type: String
  BootstrapS3Url:
    Type: String

Resources:
  VPCStack:
    Type: AWS::CloudFormation::Stack
    Properties:
      TemplateURL: !Ref VpcTemplateUrl
      Parameters:
        VpcCIDR: !Ref VpcCIDR
        PublicSubnet1CIDR: !Ref PublicSubnet1CIDR
        PublicSubnet2CIDR: !Ref PublicSubnet2CIDR
        PrivateSubnet1CIDR: !Ref PrivateSubnet1CIDR
        PrivateSubnet2CIDR: !Ref PrivateSubnet2CIDR
        
  SecurityStack:
    Type: AWS::CloudFormation::Stack
    Properties:
      TemplateURL: !Ref SecurityTemplateUrl
      Parameters:
        VPCID: !GetAtt VPCStack.Outputs.VPCID

  ComputeStack:
    Type: AWS::CloudFormation::Stack
    Properties:
      TemplateURL: !Ref ComputeTemplateUrl
      Parameters:
        KeyName: !Ref KeyName
        VPCID: !GetAtt VPCStack.Outputs.VPCID
        PublicSubnet1: !GetAtt VPCStack.Outputs.PublicSubnet1
        PublicSubnet2: !GetAtt VPCStack.Outputs.PublicSubnet2
        PrivateSubnet1: !GetAtt VPCStack.Outputs.PrivateSubnet1
        PrivateSubnet2: !GetAtt VPCStack.Outputs.PrivateSubnet2
        ALBSG: !GetAtt SecurityStack.Outputs.ALBSecurityGroup
        WebSG: !GetAtt SecurityStack.Outputs.WebSecurityGroup

  RDSStack:
    Type: AWS::CloudFormation::Stack
    Properties:
      TemplateURL: !Ref RdsTemplateUrl
      Parameters:
        DBUsername: !Ref DBUsername
        DBPassword: !Ref DBPassword
        VPCID: !GetAtt VPCStack.Outputs.VPCID
        DBSubnet1: !GetAtt VPCStack.Outputs.PrivateSubnet1
        DBSubnet2: !GetAtt VPCStack.Outputs.PrivateSubnet2
        DBSecurityGroup: !GetAtt SecurityStack.Outputs.DBSecurityGroup

  BootstrapStack:
    Type: AWS::CloudFormation::Stack
    Properties:
      TemplateURL:!Ref BootstrapTemplateUrl
      Parameters:
        WebAppInstanceId: !GetAtt ComputeStack.outputs.WebAppInstanceId
        WebAppInstanceProfileName: !GetAtt ComputeStack.Outputs.WebAppInstanceProfileName
        DBSecretArn: !GetAtt RDSStack.Outputs.DBSecretArn
        RdsEndpoint: !GetAtt RDSStack.Outputs.RdsEndpoint
        BootstrapScriptS3URL: !Ref BootstrapScriptS3URL
