AWSTemplateFormatVersion: '2010-09-09'
Description: Master template for deploying Shopalyst Infrastructure

Parameters:
  VpcCIDR:
    Type: String
  PublicSubnet1CIDR:
    Type: String
  PublicSubnet2CIDR:
    Type: String
  PrivateSubnet1CIDR:
    Type: String
  PrivateSubnet2CIDR:
    Type: String
  BootstrapScriptS3URL:
    Type: String

Resources:
  VPCStack:
    Type: AWS::CloudFormation::Stack
    Properties:
      TemplateURL: <S3-URL-to-vpc.yaml>
      Parameters:
        VpcCIDR: !Ref VpcCIDR
        PublicSubnet1CIDR: !Ref PublicSubnet1CIDR
        PublicSubnet2CIDR: !Ref PublicSubnet2CIDR
        PrivateSubnet1CIDR: !Ref PrivateSubnet1CIDR
        PrivateSubnet2CIDR: !Ref PrivateSubnet2CIDR

  ComputeStack:
    Type: AWS::CloudFormation::Stack
    Properties:
      TemplateURL: <S3-URL-to-compute.yaml>

  RDSStack:
    Type: AWS::CloudFormation::Stack
    Properties:
      TemplateURL: <S3-URL-to-rds.yaml>

  BootstrapStack:
    Type: AWS::CloudFormation::Stack
    Properties:
      TemplateURL: <S3-URL-to-bootstrap.yaml>
      Parameters:
        WebAppInstanceId: !GetAtt ComputeStack.Outputs.WebAppInstanceId
        WebAppInstanceProfileName: !GetAtt ComputeStack.Outputs.WebAppInstanceProfileName
        DBSecretArn: !GetAtt RDSStack.Outputs.DBSecretArn
        RdsEndpoint: !GetAtt RDSStack.Outputs.RdsEndpoint
        BootstrapScriptS3URL: !Ref BootstrapScriptS3URL
