AWSTemplateFormatVersion: '2010-09-09'
Description: Attach policies to EC2 and execute bootstrap script from S3

Parameters:
  WebAppInstanceId:
    Type: String
  WebAppInstanceProfileName:
    Type: String
  DBSecretArn:
    Type: String
  RdsEndpoint:
    Type: String
  BootstrapScriptS3URL:
    Type: String

Resources:
  BootstrapPolicy:
    Type: AWS::IAM::Policy
    Properties:
      PolicyName: AllowSecretsAndRDSBootstrapAccess
      Roles:
        - !Ref WebAppInstanceProfileName
      PolicyDocument:
        Version: '2012-10-17'
        Statement:
          - Effect: Allow
            Action:
              - secretsmanager:GetSecretValue
              - rds:DescribeDBInstances
            Resource: '*'

  WebAppInitCommand:
    Type: AWS::SSM::Association
    Properties:
      Name: AWS-RunShellScript
      Targets:
        - Key: InstanceIds
          Values:
            - !Ref WebAppInstanceId
      Parameters:
        commands:
          - !Sub "curl -o /tmp/bootstrap.sh ${BootstrapScriptS3URL}"
          - "chmod +x /tmp/bootstrap.sh"
          - !Sub "bash /tmp/bootstrap.sh ${DBSecretArn} ${RdsEndpoint}"
      DocumentVersion: "1"
      AssociationName: WebAppBootstrapScript
